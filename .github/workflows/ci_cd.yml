name: ETL Pipeline

on:
    workflow_dispatch:

    # schedule:
    #     - cron: '0 0 * * *'  # Runs at 12.00 AM every day
    push:
        branches:
            - main
            - feat/etl-service



jobs:
    extract-and-load:
        name: Extract and Load Raw Data to Postgres
        runs-on: ubuntu-latest
        env:
            DATABASE_USER: ${{ secrets.DATABASE_USER }}
            DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
            DATABASE_NAME: ${{ secrets.DATABASE_NAME }}


        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Start PostgreSQL container
              run: |
                docker run -d \
                --name postgres_test \
                -e POSTGRES_USER=${{ secrets.DATABASE_USER }} \
                -e POSTGRES_PASSWORD=${{ secrets.DATABASE_PASSWORD }} \
                -e POSTGRES_DB=${{ secrets.DATABASE_NAME }} \
                -v ${{ github.workspace }}/scripts/pg_init.sql:/docker-entrypoint-initdb.d/pg_init.sql:ro \
                -p 5432:5432 \
                postgres:14
                    
                echo "Waiting for PostgreSQL to be ready..."
                for i in {1..15}; do
                    if docker exec postgres_test pg_isready -U ${{ secrets.DATABASE_USER }} > /dev/null 2>&1; then
                        echo "‚úÖ PostgreSQL is ready!"
                        break
                    fi
                    
                    echo "‚è≥ Waiting for database ($i/15)..."
                    sleep 5
                done

            - name: Set up python 3.10
              uses: actions/setup-python@v5
              with:
                python-version: "3.10"
            
            - name: Install dependencies
              run: |
                echo "Installing requirements ..."
                python -m pip install --upgrade pip
                pip install -r requirements.txt

            - name: Run ETL
              env:
                DATABASE_NAME: ${{ env.DATABASE_NAME }}
                DATABASE_USER: ${{ env.DATABASE_USER }}
                DATABASE_PASSWORD: ${{ env.DATABASE_PASSWORD }}
                DATABASE_HOST: localhost
                PORT: 5432
              run: |
                echo 'üöÄ Starting ETL process...'
            
                python3 etl/main.py
                echo '‚úÖ ETL pipeline completed successfully.'


            

